<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: apis/spritpreisrechner.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: apis/spritpreisrechner.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 * @file apis/spritpreisrechner.js
 *
 * @author fewieden
 * @license MIT
 *
 * @see  https://github.com/fewieden/MMM-Fuel
 */

/**
 * @external node-fetch
 * @see https://www.npmjs.com/package/node-fetch
 */
const fetch = require('node-fetch');

/**
 * @module apis/spritpreisrechner
 * @description Queries data from spritpreisrechner.at
 *
 * @requires external:node-fetch
 *
 * @param {Object} config - Configuration.
 * @param {number} config.lat - Latitude of Coordinate.
 * @param {number} config.lng - Longitude of Coordinate.
 * @param {int} config.radius - Lookup area for gas stations.
 * @param {string} config.sortBy - Type to sort by price.
 * @param {string[]} config.types - Requested fuel types.
 * @param {boolean} config.showOpenOnly - Flag to show only open gas stations.
 *
 * @returns {Object} Object with function getData.
 */
module.exports = config => {
    /** @member {string} baseUrl - API url */
    const baseUrl = 'https://api.e-control.at/sprit/1.0';

    /** @member {Object} types - Mapping of fuel types to API fuel types. */
    const types = {
        diesel: 'DIE',
        e5: 'SUP',
        gas: 'GAS'
    };

    /**
     * @function generateUrl
     * @description Helper function to generate API request url.
     *
     * @param {string} type - Fuel type
     * @returns {string} url
     */

    const generateUrl = type => `${baseUrl}/search/gas-stations/by-address?latitude=${config.lat}&amp;longitude=${
        config.lng}&amp;fuelType=${types[type]}&amp;includeClosed=${!config.showOpenOnly}`;

    /**
     * @function requestFuelType
     * @description API request for specified type.
     * @async
     *
     * @param {string} type - Fuel type.
     * @returns {Promise} Object with fuel type and data.
     */
    const requestFuelType = async type => {
        const response = await fetch(generateUrl(type));
        return {
            type,
            data: await response.json()
        };
    };

    /**
     * @function compareStations
     * @description Helper function to compare gas stations.
     *
     * @param {Object} a - Gas Station
     * @param {Object} b - Gas Station
     *
     * @returns {boolean} Flag if the gas stations are equal.
     */
    const compareStations = (a, b) => a.location.city === b.location.city
        &amp;&amp; a.location.postalCode === b.location.postalCode
        &amp;&amp; a.name === b.name
        &amp;&amp; a.location.latitude === b.location.latitude
        &amp;&amp; a.location.longitude === b.location.longitude;

    /**
     * @function reducePrice
     * @description Reduces array of prices to single price.
     *
     * @param {Object[]} prices - All prices.
     * @returns {number} Highest price or -1 if there is no price.
     */
    const reducePrice = prices => prices.reduce((current, price) => {
        if (!Object.prototype.hasOwnProperty.call(price, 'amount') || price.amount === '') {
            return current;
        }
        return current &lt; price.amount ? price.amount : current;
    }, -1);

    /**
     * @function filterStations
     * @description Helper function to filter gas stations.
     *
     * @param {Object} station - Gas Station
     *
     * @returns {boolean} To keep or filter the station.
     */
    const filterStations = station => {
        const prices = Object.keys(station.prices);
        return !prices.every(type => station.prices[type] === -1);
    };

    /**
     * @function sortByDistance
     * @description Helper function to sort gas stations by distance.
     *
     * @param {Object} a - Gas Station
     * @param {Object} b - Gas Station
     *
     * @returns {number} Sorting weight.
     */
    const sortByDistance = (a, b) => a.distance - b.distance;

    /**
     * @function normalizeStations
     * @description Helper function to normalize the structure of gas stations for the UI.
     *
     * @param {Object[]} stations - Gas Station.
     * @param {string[]} keys - Fuel types except config option sortBy.
     *
     * @returns {void}
     *
     * @see apis/README.md
     */
    const normalizeStations = (stations, keys) => {
        stations.forEach((value, index) => {
            /* eslint-disable no-param-reassign */
            stations[index].name = value.name;
            stations[index].prices = { [config.sortBy]: reducePrice(value.prices) };
            keys.forEach(type => {
                stations[index].prices[type] = -1;
            });
            stations[index].isOpen = value.open;
            stations[index].address = `${value.location.postalCode} ${value.location.city} - ${value.location.address}`;
            stations[index].lat = parseFloat(value.location.latitude);
            stations[index].lng = parseFloat(value.location.longitude);
            /* eslint-enable no-param-reassign */
        });
    };

    return {
        /**
         * @function getData
         * @description Performs the data query and processing.
         * @async
         *
         * @returns {Object} Returns object described in the provider documentation.
         *
         * @see apis
         */
        async getData() {
            const responses = await Promise.all(config.types.map(requestFuelType));
            const collection = {};
            responses.forEach(element => {
                collection[element.type] = element.data;
            });

            let stations = collection[config.sortBy];

            const maxPrices = {};
            for (const type in collection) {
                for (const station of collection[type]) {
                    for (const price of station.prices) {
                        if (!maxPrices[price.fuelType] || price.amount > maxPrices[price.fuelType]) {
                            maxPrices[price.fuelType] = price.amount;
                        }
                    }
                }
            }

            stations = stations.filter(station => station.distance &lt;= config.radius);

            delete collection[config.sortBy];
            const keys = Object.keys(collection);

            normalizeStations(stations, keys);

            keys.forEach(type => {
                collection[type].forEach(station => {
                    for (let i = 0; i &lt; stations.length; i += 1) {
                        if (compareStations(station, stations[i])) {
                            stations[i].prices[type] = reducePrice(station.prices);
                            break;
                        }
                    }
                });
            });

            for (const station of stations) {
                for (const type in station.prices) {
                    if (station.prices[type] === -1) {
                        station.prices[type] = `>${maxPrices[types[type]]}`;
                    }
                }
            }

            stations = stations.filter(filterStations);

            const distance = stations.slice(0);
            distance.sort(sortByDistance);

            return {
                types: ['diesel', 'e5', 'gas'],
                unit: 'km',
                currency: 'EUR',
                byPrice: stations,
                byDistance: distance
            };
        }
    };
};
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-apis_spritpreisrechner.html">apis/spritpreisrechner</a></li><li><a href="module-apis_tankerkoenig.html">apis/tankerkoenig</a></li><li><a href="module-apis_utils_Coordinate.html">apis/utils/Coordinate</a></li><li><a href="module-MMM-Fuel.html">MMM-Fuel</a></li><li><a href="module-node_helper.html">node_helper</a></li></ul><h3>Externals</h3><ul><li><a href="external-fs-extra.html">fs-extra</a></li><li><a href="external-Log.html">Log</a></li><li><a href="external-Module.html">Module</a></li><li><a href="external-node-fetch.html">node-fetch</a></li><li><a href="external-node_helper.html">node_helper</a></li><li><a href="external-path.html">path</a></li></ul><h3>Global</h3><ul><li><a href="global.html#deg2rad">deg2rad</a></li><li><a href="global.html#EARTH">EARTH</a></li><li><a href="global.html#rad2deg">rad2deg</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Wed Dec 26 2018 14:42:07 GMT+0100 (Mitteleurop√§ische Zeit)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
